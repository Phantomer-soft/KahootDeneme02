<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Quiz Düzenle</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-warning">
            <h3 class="mb-0"><i class="bi bi-pencil"></i> Quiz Düzenle</h3>
        </div>

        <div class="card-body">
            <input type="hidden" id="quizId">

            <div class="mb-3">
                <label>Başlık</label>
                <input id="quizTitle" class="form-control">
            </div>

            <div class="mb-3">
                <label>Açıklama</label>
                <textarea id="quizDescription" class="form-control"></textarea>
            </div>

            <div class="mb-3">
                <label>Kategori</label>
                <select id="quizCategory" class="form-select">
                    <option value="11111111-1111-1111-1111-111111111111">Genel Kültür</option>
                    <option value="22222222-2222-2222-2222-222222222222">Matematik</option>
                    <option value="33333333-3333-3333-3333-333333333333">Tarih</option>
                    <option value="44444444-4444-4444-4444-444444444444">Bilim</option>
                    <option value="55555555-5555-5555-5555-555555555555">Teknoloji</option>
                    <option value="66666666-6666-6666-6666-666666666666">Spor</option>
                    <option value="77777777-7777-7777-7777-777777777777">Sanat</option>
                    <option value="88888888-8888-8888-8888-888888888888">Diğer</option>
                </select>
            </div>

            <div id="questionsContainer"></div>

            <button class="btn btn-success mt-3" onclick="addQuestion()">Soru Ekle</button>
            <button class="btn btn-primary mt-3" onclick="submitEdit()">Kaydet</button>
        </div>
    </div>
</div>

<template id="questionTemplate">
    <div class="card mt-3 question-wrapper">
        <input type="hidden" class="question-id">

        <div class="card-body">
            <h5>Soru Metni</h5>
            <textarea class="form-control question-text mb-2"></textarea>
            <h5>Süre</h5>
            <input type="number" class="form-control question-time mb-2" placeholder="Süre">
            <h5>Puan</h5>
            <input type="number" class="form-control question-point mb-2" placeholder="Puan">
            <h5>Şıklar</h5>
            <div class="options"></div>

            <button class="btn btn-sm btn-outline-primary" onclick="addOption(this)">Şık Ekle</button>
        </div>
    </div>
</template>

<template id="optionTemplate">
    <div class="input-group mb-2 option">
        <input type="hidden" class="answer-id">
        <div class="input-group-text">
            <input type="radio" class="correct">
        </div>
        <input class="form-control option-text">
        <button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>
    </div>
</template>

<script>
let questionIndex = 0;

   async function loadQuiz() {
    const quizIdParam = localStorage.getItem("editQuiz");
    const res = await fetch(`/teacher/quiz/getquiz?id=${quizIdParam}`);
    const quiz = await res.json();

    quizId.value = quiz.id;
    quizTitle.value = quiz.title;
    quizDescription.value = quiz.description;
    quizCategory.value = quiz.categoryId;

    // ✅ Soruları sırala
    const sortedQuestions = quiz.questions.sort((a, b) => a.order - b.order);

    sortedQuestions.forEach(q => {
        // ✅ Her sorunun cevaplarını sırala
        q.answers = q.answers.sort((a, b) => a.answerOrder - b.answerOrder);
        addQuestion(q);
    });
}

function addQuestion(data = null) {
    const clone = questionTemplate.content.cloneNode(true);
    const wrapper = clone.querySelector('.question-wrapper');
    const localIndex = questionIndex++; 

    if (data) {
        wrapper.querySelector('.question-id').value = data.id;
        wrapper.querySelector('.question-text').value = data.text;
        wrapper.querySelector('.question-time').value = data.time;
        wrapper.querySelector('.question-point').value = data.point;

        // ✅ Cevaplar zaten sıralı geldi
        data.answers.forEach(a => {
            const op = addOption(wrapper, a, localIndex);
            if (a.isCorrect) {
                op.querySelector('.correct').checked = true;
            }
        });
    }

    questionsContainer.appendChild(clone);
}

function addOption(source, data = null, qIndex = null) {
    let wrapper;

    if (source instanceof HTMLElement && source.tagName === "BUTTON") {
        wrapper = source.closest('.question-wrapper');
        qIndex = [...document.querySelectorAll('.question-wrapper')].indexOf(wrapper);
    } else {
        wrapper = source;
    }

    const options = wrapper.querySelector('.options');
    if (!options) {
        console.error("options bulunamadı", wrapper);
        return;
    }

    const clone = optionTemplate.content.cloneNode(true);
    const op = clone.querySelector('.option');
    const radio = clone.querySelector('.correct');
    radio.name = "q" + qIndex;

    if (data) {
        clone.querySelector('.answer-id').value = data.id;
        clone.querySelector('.option-text').value = data.text;
        clone.querySelector('.answer-order')?.setAttribute('value', data.answerOrder);
    }

    options.appendChild(op);
    return op;
}

async function submitEdit() {
    const quiz = {
        quizId: quizId.value,
        title: quizTitle.value,
        description: quizDescription.value,
        categoryName: quizCategory.value,
        questions: []
    };

    document.querySelectorAll('.question-wrapper').forEach(q => {
        const answers = [...q.querySelectorAll('.option')].map((o, i) => ({
            answerId: o.querySelector('.answer-id').value || null,
            text: o.querySelector('.option-text').value,
            answerOrder: i,
            isCorrect: o.querySelector('.correct').checked
        }));

        quiz.questions.push({
            questionId: q.querySelector('.question-id').value || null,
            text: q.querySelector('.question-text').value,
            time: +q.querySelector('.question-time').value,
            point: +q.querySelector('.question-point').value,
            answers
        });
    });

    await fetch("/teacher/quiz/UpdateQuiz", {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "UserId": localStorage.getItem("userid")
        },
        body: JSON.stringify(quiz)
    });
    window.location.href = "ogretmen.html";
    localStorage.removeItem("editQuiz");
    alert("Quiz güncellendi");
}

loadQuiz();
</script>
</body>
</html>
